<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/.thymeleaf/layout"
      layout:decorate="~{layouts/base}">

<!-- 현재 페이지에서만 사용하는 컨텐츠(내용) 정의 -->
<div layout:fragment="content">
    <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <div class="lg:grid lg:grid-cols-2 lg:gap-x-12 lg:items-start">
            <!-- 이미지 영역 -->
            <div class="space-y-4">
                <!-- 대표 이미지 -->
                <div>
                    <img id="mainImage" th:src="${item.itemImgDTOList[0].imgUrl}" alt="대표 상품 이미지" class="w-full h-auto object-cover rounded-lg shadow-md">
                </div>
                <!-- 썸네일 이미지 -->
                <div class="grid grid-cols-5 gap-2">
                    <div th:each="itemImg : ${item.itemImgDTOList}">
                        <img th:src="${itemImg.imgUrl}" alt="상품 썸네일" class="thumbnail-img w-full h-auto object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-gray-500 transition">
                    </div>
                </div>
            </div>

            <!-- 상품 정보 및 액션 영역 -->
            <div class="mt-10 lg:mt-0">
                <input type="hidden" th:value="${item.id}" id="itemId" />
                <input type="hidden" th:value="${item.price}" id="price" />

                <!-- 상품명 -->
                <h1 class="text-3xl font-bold tracking-tight text-gray-900" th:text="${item.itemNm}"></h1>

                <!-- 가격 -->
                <div class="mt-3">
                    <p class="text-3xl tracking-tight text-gray-900" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + '원'"></p>
                </div>

                <!-- 상품 상태 -->
                <div class="mt-4">
                    <span th:if="${item.itemSellStatus == T(com.example.mallapi.constant.ItemSellStatus).SELL}" class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2.5 py-1 rounded-full">판매중</span>
                    <span th:unless="${item.itemSellStatus == T(com.example.mallapi.constant.ItemSellStatus).SELL}" class="inline-block bg-red-100 text-red-800 text-xs font-medium px-2.5 py-1 rounded-full">품절</span>
                </div>

                <!-- 상품 상세 설명 (간략) -->
                <div class="mt-6 space-y-6 text-base text-gray-700">
                    <p th:text="${item.itemDetail}"></p>
                </div>

                <div class="mt-6">
                    <!-- 수량 -->
                    <div class="flex items-center">
                        <label for="count" class="mr-4 text-sm font-medium text-gray-900">수량</label>
                        <input type="number" name="count" id="count" value="1" min="1" max="100" class="w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>

                    <!-- 총 금액 -->
                    <div class="mt-8 flex justify-between items-center">
                        <span class="text-xl font-bold text-gray-900">총 상품 금액</span>
                        <span id="totalPrice" class="text-2xl font-bold text-indigo-600"></span>
                    </div>

                    <!-- 액션 버튼 -->
                    <div class="mt-8 grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                        <button th:disabled="${item.itemSellStatus != T(com.example.mallapi.constant.ItemSellStatus).SELL}" type="button" onclick="addCartJS()" class="w-full bg-gray-800 border border-transparent rounded-md py-3 px-8 flex items-center justify-center text-base font-medium text-white hover:bg-gray-700 disabled:bg-gray-300">장바구니 담기</button>
                        <button th:disabled="${item.itemSellStatus != T(com.example.mallapi.constant.ItemSellStatus).SELL}" type="button" onclick="orderJS()" class="w-full bg-indigo-600 border border-transparent rounded-md py-3 px-8 flex items-center justify-center text-base font-medium text-white hover:bg-indigo-700 disabled:bg-gray-300">바로 구매</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 상품 상세 이미지 (하단) -->
        <div class="mt-16 pt-10 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-6">상품 상세 정보</h2>
            <div class="space-y-6">
                <div th:each="itemImg : ${item.itemImgDTOList}" class="flex justify-center">
                    <img th:if="${not #strings.isEmpty(itemImg.imgUrl)}" th:src="${itemImg.imgUrl}" class="max-w-full h-auto rounded-lg">
                </div>
            </div>
        </div>
    </div>

    <!-- Axios & Custom JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:src="@{/axiosJS/axiosOrder.js}"></script>
</div>

<!-- 현재 페이지에서만 사용하는 CSS정의 -->
<style layout:fragment="mystyle" th:inline="css">
    .thumbnail-img.active {
        border-color: #4f46e5; /* indigo-600 */
        box-shadow: 0 0 0 2px #a5b4fc; /* indigo-300 */
    }
</style>

<!-- 현재 페이지에서만 사용하는 javasscript 정의 -->
<script layout:fragment="myscript" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const price = parseFloat(document.getElementById('price').value);
        const countInput = document.getElementById('count');
        const totalPriceEl = document.getElementById('totalPrice');

        function calculateTotalPrice() {
            const count = parseInt(countInput.value);
            const total = price * count;
            totalPriceEl.textContent = total.toLocaleString('ko-KR') + '원';
        }

        countInput.addEventListener('change', calculateTotalPrice);
        calculateTotalPrice(); // 초기 로드 시 총액 계산

        // 이미지 갤러리 기능
        const mainImage = document.getElementById('mainImage');
        const thumbnails = document.querySelectorAll('.thumbnail-img');

        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function () {
                mainImage.src = this.src;
                // 활성 썸네일 스타일 업데이트
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });
        // 첫 번째 썸네일에 active 클래스 추가
        if(thumbnails.length > 0) {
            thumbnails[0].classList.add('active');
        }
    });

    // 장바구니 담기
    function addCartJS() {
        const cartItemData = {
            itemId: document.getElementById('itemId').value,
            count: document.getElementById('count').value
        };
        cartItem(cartItemData)
            .then(result => {
                alert("상품을 장바구니에 담았습니다.");
                // 필요 시 장바구니 페이지로 이동
                // location.href = '/cart'; 
            })
            .catch(e => {
                if (e.response && e.response.status === 500) {
                    alert("로그인 후 이용해 주세요");
                    location.href = '/members/login';
                } else {
                    alert('Error: ' + (e.response ? e.response.data : e.message));
                }
            });
    }

    // 주문하기
    function orderJS() {
        const orderItemData = {
            itemId: document.getElementById('itemId').value,
            count: document.getElementById('count').value
        };
        orderItemFn(orderItemData)
            .then(result => {
                alert('주문이 완료되었습니다.');
                location.href = '/'; // 주문 완료 후 메인 페이지로 이동
            })
            .catch(e => {
                if (e.response && e.response.status === 500) {
                    alert("로그인 후 이용해 주세요");
                    location.href = '/members/login';
                } else {
                    alert('Error: ' + (e.response ? e.response.data : e.message));
                }
            });
    }
</script>

</html>
