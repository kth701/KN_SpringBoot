<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">

    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
            <div class="bg-white p-8 md:p-12 rounded-lg border border-gray-200">
                <!-- 1개의 폼 view로 입력폼과 조회(수정)폼으로 사용 하기 -->
                <h1  th:if="${memberFormDTO.email == null}" class="text-2xl font-bold text-gray-900 mb-8">회원가입</h1>
                <h1  th:if="${memberFormDTO.email != null}" class="text-2xl font-bold text-gray-900 mb-8">회원정보</h1>

                <form th:object="${memberFormDTO}" method="post">
                    <!-- email -->
                    <div class="mt-6">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">이메일 (로그인 ID)</label>
<!--                        <input type="email" id="email" th:field="*{email}" class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm" placeholder="이메일 주소를 입력하세요.">-->
                        <input type="email" id="email" th:field="*{email}"
                               th:readonly="${memberFormDTO.email != null}"
                               class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm"
                               th:classappend="${memberFormDTO.email != null} ? 'bg-gray-100' : ''"
                               placeholder="이메일 주소를 입력하세요.">
                        <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="text-xs text-red-500 mt-1"></p>
                        <p id="emailError"  class="text-xs text-red-500 mt-1"></p><!--회원 중복 가입 메시지-->
                    </div>
                    <!--  Current Password (only for member modification) :  -->
                    <!-- 1. 비밀번호 변경 테스트용 : 회원 수정폼에서   기존비밀번호 입력하고 확인후 비밀번호 수정 (비밀번호 변경 별도의 폼에서 구현필요) -->
                    <!--
                               읽기 전용 사용 할 경우  추가 적용, 수정작업에서 기존 비빌 번호 입력 확인을 위한 input요소 사용하기 위해 아래 속성 제거 할 것

                               th:readonly="${memberFormDTO.email != null}"
                               th:value="${memberFormDTO.email != null ? '${memberFormDTO.savedPw}' : ''}"
                              th:classappend="${memberFormDTO.email != null} ? 'bg-gray-100' : ''"
                     -->
                    <div class="mt-6" th:if="${memberFormDTO.email != null}" >
                        <label for="currentPw" class="block text-sm font-medium text-gray-700 mb-2">기존 비밀번호(테스트용)</label>
                        <input type="password" id="currentPw"
                               th:field="*{currentPw}"
                               th:readonly="${memberFormDTO.email != null}"ㄴ
                               th:value="${memberFormDTO.email != null ? '${memberFormDTO.savedPw}' : ''}"
                               th:classappend="${memberFormDTO.email != null} ? 'bg-gray-100' : ''"
                               class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm" placeholder="현재 비밀번호를 입력하세요.">
                        <p id="currentPwError" class="text-xs text-red-500 mt-1"></p>
                    </div>



                    <!-- 2. 비밀번호 테스트용 : 회원 수정폼에서 비밀번호 수정 (비밀번호 변경 별도의 폼에서 구현필요) -->
                    <!-- New Password -->
                    <div class="mt-6">
                        <label for="pw"  th:text="${memberFormDTO.email != null} ? '새 비밀번호' : '비밀번호'" class="block text-sm font-medium text-gray-700 mb-2"></label>
                        <input type="password" id="pw" th:field="*{pw}"
                               class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm" th:placeholder="${memberFormDTO.email != null} ? '새 비밀번호를 입력하세요.' : '비밀번호를 입력하세요.'">
                        <p th:if="${#fields.hasErrors('pw')}" th:errors="*{pw}" class="text-xs text-red-500 mt-1"></p>
                    </div>

                    <!-- Confirm New Password (only for member modification) -->
                    <div class="mt-6">
                        <label for="confirmPw"   th:text="${memberFormDTO.email != null} ? '새 비밀번호 확인' : '비밀번호 확인'"
                               class="block text-sm font-medium text-gray-700 mb-2"></label>
                        <input type="password" id="confirmPw"  th:field="*{confirmPw}"
                               class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm"  th:placeholder="${memberFormDTO.email != null} ? '새 비밀번호 확인를 입력하세요.' : '비밀번호 확인를 입력하세요.'">
                        <p  id="confirmPwError" class="text-xs text-red-500 mt-1"></p>
                    </div>



                    <!-- nickname -->
                    <div class="mt-6">
                        <label for="nickname" class="block text-sm font-medium text-gray-700 mb-2">닉네임</label>
                        <input type="text" id="nickname" th:field="*{nickname}" class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:outline-none focus:ring-0 sm:text-sm" placeholder="사용할 닉네임을 입력하세요.">

                    </div>

                    <!-- social -->
                    <div class="mt-6 " th:if="${memberFormDTO.email != null}">
<!--                        <label for="social" class="block text-sm font-medium text-gray-700 mb-2">소셜 계정 가입여부</label>-->
<!--                        <input type="checkbox" id="social" name="social" th:checked="${memberFormDTO.social}"   class="h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-0">-->
                        <span class="ml-0 text-sm text-gray-700">회원가입 유형: <span th:text="${memberFormDTO.social} ? '소설계정 가입' : '일반회원 가입'"></span>
                        </span>
                    </div>

                    <!-- 탈퇴 여부:  가입상태일때만 처리 또는 매니저및 관리자모드일 경우 처리 -->
                    <div class="mt-6 " th:if="${memberFormDTO.email != null && !memberFormDTO.del ||  ( #lists.contains(memberFormDTO.roleNames, 'MANAGER') or #lists.contains(memberFormDTO.roleNames, 'ADMIN') )  }">
                        <label for="del" class="block text-sm font-medium text-gray-700 mb-2">회원 탈퇴하려면 체크하세요.</label>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input type="checkbox" id="del" name="del" th:checked="${memberFormDTO.del}" class="h-4 w-4 text-gray-600 border-gray-300 rounded focus:ring-0">
                            </div>
                            <div class="ml-2 text-sm text-gray-700"><span th:text="${!memberFormDTO.del} ? '회원' : '비회원(탈퇴)'"></span></div>
                        </div>
                    </div>

                    <!-- 1.권한 설정 checkbox:  현재로그인상태이고 구분자 관계없이 '메니저' 또는 '관리자'모드에서 모두표시 -->
<!--                     role test:   [[${memberFormDTO.roleNames}]]-->
<!--                    <div class="mt-6" th:if="${#authorization.expression('hasRole(''MANAGER'')') || #authorization.expression('hasRole(''ADMIN'')')}">-->

                    <!--2. test 용 -->
                    <!--                    <div class="mt-6">-->

                    <!-- 3.관리잠 모드 인 경우일 경우만 표시-->
                    <div class="mt-6" th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                        <label class="block text-sm font-medium text-gray-700 mb-2">권한 설정  </label>

                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="role_USER" name="roleNames" type="checkbox" value="USER"
                                       th:checked="${#lists.contains(memberFormDTO.roleNames, 'USER')}"
                                       class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="role_USER" class="font-medium text-gray-700">사용자</label>
                            </div>
                        </div>
                        <div class="relative flex items-start mt-2">
                            <div class="flex items-center h-5">
                                <input id="role_MANAGER" name="roleNames" type="checkbox" value="MANAGER"
                                       th:checked="${#lists.contains(memberFormDTO.roleNames, 'MANAGER')}"
                                       class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="role_MANAGER" class="font-medium text-gray-700">매니저</label>
                            </div>
                        </div>
                        <div class="relative flex items-start mt-2" >
                            <div class="flex items-center h-5">
                                <input id="role_ADMIN" name="roleNames" type="checkbox" value="ADMIN"
                                       th:checked="${#lists.contains(memberFormDTO.roleNames, 'ADMIN')}"
                                       class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="role_ADMIN" class="font-medium text-gray-700">관리자</label>
                            </div>
                        </div>
                    </div>




                    <!-- hidden fields
                    <input type="hidden" th:field="*{social}" />
                    <input type="hidden" th:field="*{del}" />
                    <div th:each="roleName, stat : *{roleNames}">
                        <input type="hidden" th:name="|roleNames[${stat.index}]|" th:value="${roleName}" />
                    </div> -->

                    <!-- Action Buttons -->
                    <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end">
                        <button th:formaction="${memberFormDTO.email != null} ? @{/members/modify} : @{/members/new}" type="submit"
                                class="rounded-md bg-gray-800 py-2 px-6 text-sm font-semibold text-white shadow-sm hover:bg-gray-700" th:text="${memberFormDTO.email != null} ? '회원 정보 수정' : '회원가입'"></button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- 현재 페이지에서만 사용하는 CSS정의 -->
    <style layout:fragment="mystyle"  th:inline="css">
        .filedError {
          color: red;
          font-size: 0.8em;


          padding: 0.2em;
          padding-left:1em; padding-right: 1em;
        }
    </style>

    <!-- 현재 페이지에서만 사용하는 javasscript 정의 -->
    <script layout:fragment="myscript" th:inline="javascript">

        // DOM 메모리에 적재 되면 처리하는 이벤트핸들러
        document.addEventListener('DOMContentLoaded', function() {


            // --------------------------------------------------------------------------------------------- //
            // 회원 가입 항목(이메일, 비밀번호와 비밀번호 동일여부 확인) 유효성 검사 : 클라이넌트에서 체크
            // -------------------------------------------------------------------------------------------- //
            const isFormEmail = [[${memberFormDTO.email != null}]] //수정 폼일 경우 true판별
            const form = document.querySelector('form');

            const emailInput = document.getElementById('email');
            const pwInput = document.getElementById('pw');
            const confirmPwInput = document.getElementById('confirmPw');

            // 이메일 유효성 검사 함수
            function validateEmail() {
                if (!isFormEmail) { // 회원가입 폼일 경우만 이메일 유효성 처리
                    const emailValue = emailInput.value;
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailValue) {
                        emailError.innerHTML = "이메일 주소를 입력해주세요.";
                        return false;
                    }else if (!emailRegex.test(emailValue)) {
                        emailError.innerHTML = "유효한 이메일 주소를 입력해주세요.";
                        return false;
                    } else {
                        emailError.innerHTML = "";
                        return true;
                    }
                } else {
                    emailError.innerHTML = "";
                    return true;
                }
            }

            // 비밀번호 확인 함수
            function validateConfirmPassword() {
                const newPw = pwInput.value;
                const confirmPw = confirmPwInput.value;
                if (newPw !== confirmPw) {
                    if (!isFormEmail)
                        confirmPwError.innerHTML = "비밀번호와 비밀번호 확인이 일치하지 않습니다.";
                    else
                        confirmPwError.innerHTML = "새 비밀번호와 새 비밀번호 확인이 일치하지 않습니다.";
                    return false;
                } else {
                    confirmPwError.innerHTML = "";
                    return true;
                }
            }

            // 이메일 입력 필드에서 포커스를 잃었을 때 유효성 검사
            emailInput.addEventListener('blur', validateEmail);

            // 비밀번호 확인 입력 필드에서 포커스를 잃었을 때 유효성 검사
            confirmPwInput.addEventListener('blur', validateConfirmPassword);

            // 폼 제출 시 최종 유효성 검사
            form.addEventListener('submit', function(event) {
                const isEmailValid = validateEmail();
                const isConfirmPwValid = validateConfirmPassword();
                if (!isEmailValid || !isConfirmPwValid) {
                    event.preventDefault(); // 유효성 검사 실패 시 폼 제출 방지
                }
            });

            // ------------------------------------------------------------------------------------------ //
            // 서버에서 회원가입 관련 항목 체크후 에러메시지를 클라이언트에서 처리
            // 중복 체크 등 여러 에러 메시지가 있으면 처리 : errorDuplicateMessage
            // ------------------------------------------------------------------------------------------ //
            const errorMessage = [[${errorMessage}]] // email에러
            const emailError = document.querySelector('#emailError'); // emailError
            const currentPwError =   document.querySelector('#currentPwError');// 현재 비밀번호 확인
            const confirmPwError =   document.querySelector('#confirmPwError');// 새 비밀번호 확인

            // 서버에 전송받은 응답 메시지
            if (errorMessage != null ) { // 에러가 발생 했을 경우에만 처리
                console.log("-> errorMessage msg:",errorMessage.message)
                console.log("-> errorMessage:",errorMessage)


                // ------------------------------------------------------------------------------------------ //
                //서버로 받은 에러 메시지에 따라 폼에 표시할 메시지
                // ------------------------------------------------------------------------------------------ //
                if (errorMessage.message ==="BAD_CREDENTIALS" ){
                  currentPwError.innerHTML = "현재 비밀번호가 일치하지 않습니다.";
                } else  if  (errorMessage.message ==="INVALID" ){
                    confirmPwError.innerHTML = "비밀번호(새 비밀번호) 확인이 일치하지 않습니다.";
                } else if  (errorMessage.message ==="NOT_FOUND") {
                   emailError.innerHTML =  "미 가입 회원입니다. 회원 가입이 필요합니다."

                } else if (errorMessage.message ==="DUPLICATE" ) { // 에러 메세지 텅빈 상태임(test중)
                    emailError.innerHTML = "이미 가입된 회원입니다.";
                }
            }else {
                console.log("-> no error")
            }

        });
    </script>

</html>
